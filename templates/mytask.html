{% extends "base.html" %}

{% block title %}My Tasks - SmartStationery{% endblock %}

{% block extra_css %}
<style>
.task-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.task-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.task-priority {
    width: 8px;
    height: 100%;
    border-radius: 4px 0 0 4px;
}

.priority-high {
    background-color: #dc3545;
}

.priority-medium {
    background-color: #ffc107;
}

.priority-low {
    background-color: #198754;
}

.task-due-date {
    font-size: 0.85rem;
    color: #6c757d;
}

.completed {
    opacity: 0.7;
}

.completed .task-title {
    text-decoration: line-through;
    color: #6c757d;
}

.task-category {
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    background-color: #e9ecef;
    color: #495057;
}

.urgent-badge {
    background-color: #dc3545;
    color: white;
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}

.status-badge {
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">My Tasks</h1>
        <div class="text-muted">
            <i class="fas fa-user me-2"></i>Staff Dashboard
        </div>
    </div>

    <!-- Task Summary -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center p-3">
                    <h4 class="mb-0" id="totalTasks">0</h4>
                    <small>Total Tasks</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center p-3">
                    <h4 class="mb-0" id="pendingTasks">0</h4>
                    <small>Pending</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center p-3">
                    <h4 class="mb-0" id="progressTasks">0</h4>
                    <small>In Progress</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center p-3">
                    <h4 class="mb-0" id="completedTasks">0</h4>
                    <small>Completed</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Task List -->
    <div class="row" id="taskList">
        <!-- Tasks will be loaded here -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5 d-none">
        <i class="fas fa-clipboard-check fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No Tasks Assigned</h4>
        <p class="text-muted">You don't have any tasks assigned to you yet.</p>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailsModalLabel">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Task Title:</strong>
                    <p id="detailTitle" class="mb-3 mt-1"></p>
                </div>
                <div class="mb-3">
                    <strong>Description:</strong>
                    <p id="detailDescription" class="mb-3 mt-1 text-muted"></p>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Due Date:</strong>
                        <p id="detailDueDate" class="mb-2 mt-1"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Priority:</strong>
                        <p id="detailPriority" class="mb-2 mt-1"></p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Category:</strong>
                        <p id="detailCategory" class="mb-2 mt-1"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        <p id="detailStatus" class="mb-2 mt-1"></p>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Assigned By:</strong>
                    <p id="detailAssignedBy" class="mb-2 mt-1"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="taskActions">
                    <!-- Action buttons will be added here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sample tasks data assigned to this staff member
    let tasks = [
        {
            id: 1,
            title: 'Complete inventory count for stationery',
            description: 'Count all items in the stationery section including pens, pencils, notebooks, and update the inventory system with accurate numbers.',
            dueDate: '2024-01-15',
            priority: 'high',
            status: 'pending',
            category: 'Inventory',
            assignedBy: 'Store Manager'
        },
        {
            id: 2,
            title: 'Restock printer paper and supplies',
            description: 'Check current stock levels of printer paper and restock from warehouse inventory if needed.',
            dueDate: '2024-01-10',
            priority: 'medium',
            status: 'in-progress',
            category: 'Restocking',
            assignedBy: 'Assistant Manager'
        },
        {
            id: 3,
            title: 'Organize pen display area',
            description: 'Arrange pen display by brand and color, ensure all price tags are visible and correct.',
            dueDate: '2024-01-08',
            priority: 'low',
            status: 'completed',
            category: 'Merchandising',
            assignedBy: 'Store Manager'
        },
        {
            id: 4,
            title: 'Update price tags for sale items',
            description: 'Replace old price tags with new ones for all items currently on sale.',
            dueDate: '2024-01-12',
            priority: 'medium',
            status: 'pending',
            category: 'Pricing',
            assignedBy: 'Assistant Manager'
        }
    ];

    // DOM Elements
    const taskList = document.getElementById('taskList');
    const emptyState = document.getElementById('emptyState');
    const taskDetailsModal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));

    // Initialize the task list
    function renderTasks() {
        updateTaskSummary();
        
        if (tasks.length === 0) {
            taskList.classList.add('d-none');
            emptyState.classList.remove('d-none');
            return;
        }

        taskList.classList.remove('d-none');
        emptyState.classList.add('d-none');
        taskList.innerHTML = '';

        // Sort tasks: pending first, then in-progress, then completed
        const sortedTasks = [...tasks].sort((a, b) => {
            const statusOrder = { 'pending': 1, 'in-progress': 2, 'completed': 3 };
            return statusOrder[a.status] - statusOrder[b.status];
        });

        sortedTasks.forEach(task => {
            const taskElement = createTaskElement(task);
            taskList.appendChild(taskElement);
        });
    }

    // Update task summary counters
    function updateTaskSummary() {
        const totalTasks = tasks.length;
        const pendingTasks = tasks.filter(task => task.status === 'pending').length;
        const progressTasks = tasks.filter(task => task.status === 'in-progress').length;
        const completedTasks = tasks.filter(task => task.status === 'completed').length;
        
        document.getElementById('totalTasks').textContent = totalTasks;
        document.getElementById('pendingTasks').textContent = pendingTasks;
        document.getElementById('progressTasks').textContent = progressTasks;
        document.getElementById('completedTasks').textContent = completedTasks;
    }

    // Create task card HTML
    function createTaskElement(task) {
        const priorityClass = `priority-${task.priority}`;
        const isCompleted = task.status === 'completed';
        const completedClass = isCompleted ? 'completed' : '';
        const isUrgent = task.priority === 'high' && task.status !== 'completed';
        const daysUntilDue = getDaysUntilDue(task.dueDate);
        const isOverdue = daysUntilDue < 0;
        
        return document.createRange().createContextualFragment(`
            <div class="col-md-6 col-lg-4 mb-4" data-task-id="${task.id}">
                <div class="card h-100 task-card ${completedClass}">
                    <div class="d-flex h-100">
                        <div class="task-priority ${priorityClass}"></div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-1 task-title">${task.title}</h5>
                                ${isUrgent ? '<span class="urgent-badge">URGENT</span>' : ''}
                            </div>
                            
                            ${task.description ? `<p class="card-text text-muted small mb-2 flex-grow-1">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</p>` : ''}
                            
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="task-category">${task.category}</span>
                                    <span class="badge ${getStatusBadgeClass(task.status)} status-badge">
                                        ${formatStatus(task.status)}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="task-due-date ${isOverdue ? 'text-danger' : ''}">
                                        <i class="far fa-calendar-alt me-1"></i>
                                        ${formatDate(task.dueDate)}
                                        ${isOverdue ? ' (Overdue)' : daysUntilDue === 0 ? ' (Today)' : daysUntilDue === 1 ? ' (Tomorrow)' : ''}
                                    </small>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary view-task" data-task-id="${task.id}">
                                            View Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `);
    }

    // Helper functions
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }

    function formatStatus(status) {
        return status.split('-').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }

    function getStatusBadgeClass(status) {
        const statusClasses = {
            'pending': 'bg-warning',
            'in-progress': 'bg-info',
            'completed': 'bg-success'
        };
        return statusClasses[status] || 'bg-secondary';
    }

    function getDaysUntilDue(dueDate) {
        const today = new Date();
        const due = new Date(dueDate);
        today.setHours(0, 0, 0, 0);
        due.setHours(0, 0, 0, 0);
        return Math.ceil((due - today) / (1000 * 60 * 60 * 24));
    }

    // Event Listeners
    // View task details
    taskList.addEventListener('click', function(e) {
        if (e.target.closest('.view-task')) {
            const taskId = parseInt(e.target.closest('[data-task-id]').dataset.taskId);
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                showTaskDetails(task);
            }
        }
    });

    // Show task details in modal
    function showTaskDetails(task) {
        document.getElementById('detailTitle').textContent = task.title;
        document.getElementById('detailDescription').textContent = task.description || 'No description provided';
        document.getElementById('detailDueDate').textContent = formatDate(task.dueDate);
        document.getElementById('detailPriority').innerHTML = getPriorityDisplay(task.priority);
        document.getElementById('detailCategory').textContent = task.category || 'General';
        document.getElementById('detailStatus').innerHTML = `<span class="badge ${getStatusBadgeClass(task.status)}">${formatStatus(task.status)}</span>`;
        document.getElementById('detailAssignedBy').textContent = task.assignedBy;

        // Update action buttons based on task status
        const taskActions = document.getElementById('taskActions');
        taskActions.innerHTML = '';
        
        if (task.status === 'pending') {
            taskActions.innerHTML = `
                <button type="button" class="btn btn-success mark-in-progress" data-task-id="${task.id}">
                    Start Task
                </button>
            `;
        } else if (task.status === 'in-progress') {
            taskActions.innerHTML = `
                <button type="button" class="btn btn-success mark-complete" data-task-id="${task.id}">
                    Mark Complete
                </button>
            `;
        } else if (task.status === 'completed') {
            taskActions.innerHTML = `
                <button type="button" class="btn btn-warning mark-pending" data-task-id="${task.id}">
                    Reopen Task
                </button>
            `;
        }

        taskDetailsModal.show();
    }

    function getPriorityDisplay(priority) {
        const priorityColors = {
            'high': 'danger',
            'medium': 'warning',
            'low': 'success'
        };
        return `<span class="badge bg-${priorityColors[priority]}">${priority.charAt(0).toUpperCase() + priority.slice(1)} Priority</span>`;
    }

    // Handle task status updates from modal
    document.getElementById('taskActions').addEventListener('click', function(e) {
        const taskId = parseInt(e.target.dataset.taskId);
        
        if (e.target.classList.contains('mark-complete')) {
            updateTaskStatus(taskId, 'completed');
            taskDetailsModal.hide();
        } else if (e.target.classList.contains('mark-in-progress')) {
            updateTaskStatus(taskId, 'in-progress');
            taskDetailsModal.hide();
        } else if (e.target.classList.contains('mark-pending')) {
            updateTaskStatus(taskId, 'pending');
            taskDetailsModal.hide();
        }
    });

    function updateTaskStatus(taskId, newStatus) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.status = newStatus;
            renderTasks();
            showAlert(`Task marked as ${formatStatus(newStatus).toLowerCase()}!`, 'success');
        }
    }

    // Show alert function
    function showAlert(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.role = 'alert';
        alertDiv.style.zIndex = '1100';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
            alert.close();
        }, 3000);
    }

    // Initialize the task list on page load
    renderTasks();
});
</script>
{% endblock %}