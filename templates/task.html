{% extends "base.html" %}

{% block title %}Tasks - SmartStationery{% endblock %}

{% block extra_css %}
<style>
.task-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.task-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.task-priority {
    width: 10px;
    height: 100%;
    border-radius: 4px 0 0 4px;
}

.priority-high {
    background-color: #dc3545;
}

.priority-medium {
    background-color: #ffc107;
}

.priority-low {
    background-color: #198754;
}

.task-due-date {
    font-size: 0.85rem;
    color: #6c757d;
}

.task-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
}

.completed {
    opacity: 0.7;
}

.completed .task-title {
    text-decoration: line-through;
    color: #6c757d;
}

.task-category {
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    background-color: #e9ecef;
    color: #495057;
}

.status-badge {
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">My Tasks</h1>
        <div class="text-muted">
            <i class="fas fa-user me-2"></i>Staff Dashboard
        </div>
    </div>

    <!-- Task Summary -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="alertCount">4</h4>
                    <small>Alerts</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="totalTasks">2</h4>
                    <small>Total Tasks</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="pendingTasks">2</h4>
                    <small>Pending</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="progressTasks">1</h4>
                    <small>In Progress</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="completedTasks">1</h4>
                    <small>Completed</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h4 class="mb-0" id="historyCount">0</h4>
                    <small>History</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Filters -->
    <div class="card mb-4">
        <div class="card-body p-3">
            <!-- Section Tabs -->
            <ul class="nav nav-tabs mb-3" id="taskTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="current-tab" data-bs-toggle="tab" data-bs-target="#current" type="button" role="tab">
                        <i class="fas fa-tasks me-2"></i>Current Tasks
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                        <i class="fas fa-history me-2"></i>Task History
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link position-relative" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab">
                        <i class="fas fa-exclamation-triangle me-2"></i>Alerts
                        <span class="badge bg-danger rounded-pill ms-1" id="alertCount" style="display: none;">0</span>
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="taskTabContent">
                <!-- Current Tasks Tab -->
                <div class="tab-pane fade show active" id="current" role="tabpanel">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Filter by Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="all">All Tasks</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Filter by Priority</label>
                            <select class="form-select" id="priorityFilter">
                                <option value="all">All Priorities</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" id="resetFilters">
                                <i class="fas fa-sync-alt me-2"></i>Reset Filters
                            </button>
                        </div>
                    </div>
                    <div class="row" id="taskList">
                        <!-- Current tasks will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Task History Tab -->
                <div class="tab-pane fade" id="history" role="tabpanel">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Search History</label>
                            <input type="text" class="form-control" id="historySearch" placeholder="Search completed tasks...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date Range</label>
                            <select class="form-select" id="dateRange">
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 3 months</option>
                                <option value="all">All time</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-outline-primary w-100" id="applyHistoryFilter">
                                <i class="fas fa-filter me-2"></i>Apply
                            </button>
                        </div>
                    </div>
                    <div class="row" id="historyList">
                        <!-- Task history will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Alerts Tab -->
                <div class="tab-pane fade" id="alerts" role="tabpanel">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Alert Type</label>
                            <select class="form-select" id="alertTypeFilter">
                                <option value="all">All Alerts</option>
                                <option value="restock">Restock Needed</option>
                                <option value="out-of-stock">Out of Stock</option>
                                <option value="low-stock">Low Stock</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="alertPriorityFilter">
                                <option value="all">All Priorities</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-danger w-100" id="clearAllAlerts">
                                <i class="fas fa-trash me-2"></i>Clear All Alerts
                            </button>
                        </div>
                    </div>
                    <div class="row" id="alertList">
                        <!-- Alerts will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailsModalLabel">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Title:</strong>
                    <p id="detailTitle" class="mb-2"></p>
                </div>
                <div class="mb-3">
                    <strong>Description:</strong>
                    <p id="detailDescription" class="mb-2"></p>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Due Date:</strong>
                        <p id="detailDueDate" class="mb-2"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Priority:</strong>
                        <p id="detailPriority" class="mb-2"></p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Category:</strong>
                        <p id="detailCategory" class="mb-2"></p>
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        <p id="detailStatus" class="mb-2"></p>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Assigned By:</strong>
                    <p id="detailAssignedBy" class="mb-2"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sample tasks data assigned to this staff member
    let tasks = [
        {
            id: 1,
            title: 'Complete inventory count',
            description: 'Count all items in the stationery section and update the inventory system',
            dueDate: '2024-01-15',
            priority: 'high',
            status: 'pending',
            category: 'Inventory',
            assignedBy: 'Admin User',
            assignedDate: '2024-01-05'
        },
        {
            id: 2,
            title: 'Restock printer paper',
            description: 'Check printer paper levels and restock if needed',
            dueDate: '2024-01-10',
            priority: 'medium',
            status: 'in-progress',
            category: 'Restocking',
            assignedBy: 'Manager Smith',
            assignedDate: '2024-01-03'
        },
        {
            id: 3,
            title: 'Organize pen display',
            description: 'Arrange pen display by type and color',
            dueDate: '2024-01-08',
            priority: 'low',
            status: 'completed',
            category: 'Merchandising',
            assignedBy: 'Admin User',
            assignedDate: '2024-01-02'
        },
        {
            id: 4,
            title: 'Update price tags',
            description: 'Replace old price tags with new ones for items on sale',
            dueDate: '2024-01-12',
            priority: 'medium',
            status: 'pending',
            category: 'Pricing',
            assignedBy: 'Manager Smith',
            assignedDate: '2024-01-04'
        }
    ];

    // DOM Elements
    const taskList = document.getElementById('taskList');
    const statusFilter = document.getElementById('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const taskDetailsModal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));

    // Initialize the task list
    function renderTasks() {
        const status = statusFilter.value;
        const priority = priorityFilter.value;
        
        const filteredTasks = tasks.filter(task => {
            const statusMatch = status === 'all' || task.status === status;
            const priorityMatch = priority === 'all' || task.priority === priority;
            return statusMatch && priorityMatch;
        });

        updateTaskSummary();
        taskList.innerHTML = '';

        if (filteredTasks.length === 0) {
            taskList.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-tasks fa-3x mb-3 text-muted"></i>
                    <h5 class="text-muted">No tasks found</h5>
                    <p class="text-muted">Try adjusting your filters</p>
                </div>
            `;
            return;
        }

        filteredTasks.forEach(task => {
            const taskElement = createTaskElement(task);
            taskList.appendChild(taskElement);
        });
    }

    // Update task summary counters
    function updateTaskSummary() {
        const totalTasks = tasks.length;
        const pendingTasks = tasks.filter(task => task.status === 'pending').length;
        const progressTasks = tasks.filter(task => task.status === 'in-progress').length;
        const completedTasks = tasks.filter(task => task.status === 'completed').length;
        
        document.getElementById('totalTasks').textContent = totalTasks;
        document.getElementById('pendingTasks').textContent = pendingTasks;
        document.getElementById('progressTasks').textContent = progressTasks;
        document.getElementById('completedTasks').textContent = completedTasks;
    }

    // Create task card HTML
    function createTaskElement(task) {
        const priorityClass = `priority-${task.priority}`;
        const isCompleted = task.status === 'completed';
        const completedClass = isCompleted ? 'completed' : '';
        
        return document.createRange().createContextualFragment(`
            <div class="col-md-6 col-lg-4 mb-4" data-task-id="${task.id}">
                <div class="card h-100 task-card ${completedClass}">
                    <div class="d-flex h-100">
                        <div class="task-priority ${priorityClass}"></div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-1 task-title">${task.title}</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><button class="dropdown-item view-task" data-task-id="${task.id}">
                                            <i class="fas fa-eye me-2"></i>View Details
                                        </button></li>
                                        <li><button class="dropdown-item mark-complete" data-task-id="${task.id}">
                                            <i class="fas fa-check me-2"></i>Mark as Complete
                                        </button></li>
                                        <li><button class="dropdown-item mark-in-progress" data-task-id="${task.id}">
                                            <i class="fas fa-play me-2"></i>Mark In Progress
                                        </button></li>
                                    </ul>
                                </div>
                            </div>
                            
                            ${task.description ? `<p class="card-text text-muted small mb-2">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</p>` : ''}
                            
                            <div class="mt-auto pt-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        ${task.category ? `<span class="task-category me-2">${task.category}</span>` : ''}
                                        <span class="badge ${getStatusBadgeClass(task.status)} status-badge">${formatStatus(task.status)}</span>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted task-due-date">
                                        <i class="far fa-calendar-alt me-1"></i>${formatDate(task.dueDate)}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-user-tie me-1"></i>${task.assignedBy}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `);
    }

    // Helper functions
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }

    function formatStatus(status) {
        return status.split('-').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    }

    function getStatusBadgeClass(status) {
        const statusClasses = {
            'pending': 'bg-warning',
            'in-progress': 'bg-info',
            'completed': 'bg-success'
        };
        return statusClasses[status] || 'bg-secondary';
    }

    // Event Listeners
    // Mark task as complete
    taskList.addEventListener('click', function(e) {
        if (e.target.closest('.mark-complete')) {
            const taskId = parseInt(e.target.closest('[data-task-id]').dataset.taskId);
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'completed';
                renderTasks();
                showAlert('Task marked as complete!', 'success');
            }
        }
        
        // Mark task as in progress
        else if (e.target.closest('.mark-in-progress')) {
            const taskId = parseInt(e.target.closest('[data-task-id]').dataset.taskId);
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'in-progress';
                renderTasks();
                showAlert('Task marked as in progress!', 'info');
            }
        }
        
        // View task details
        else if (e.target.closest('.view-task')) {
            const taskId = parseInt(e.target.closest('[data-task-id]').dataset.taskId);
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                document.getElementById('detailTitle').textContent = task.title;
                document.getElementById('detailDescription').textContent = task.description || 'No description provided';
                document.getElementById('detailDueDate').textContent = formatDate(task.dueDate);
                document.getElementById('detailPriority').textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
                document.getElementById('detailCategory').textContent = task.category || 'General';
                document.getElementById('detailStatus').textContent = formatStatus(task.status);
                document.getElementById('detailAssignedBy').textContent = task.assignedBy;
                
                taskDetailsModal.show();
            }
        }
    });

    // Filter tasks
    [statusFilter, priorityFilter].forEach(filter => {
        filter.addEventListener('change', renderTasks);
    });

    // Reset filters
    resetFiltersBtn.addEventListener('click', function() {
        statusFilter.value = 'all';
        priorityFilter.value = 'all';
        renderTasks();
    });

    // Show alert function
    function showAlert(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.role = 'alert';
        alertDiv.style.zIndex = '1100';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remove alert after 3 seconds
        setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
            alert.close();
        }, 3000);
    }

    // Initialize the task list on page load
    renderTasks();
});
</script>
{% endblock %}




